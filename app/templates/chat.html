<!DOCTYPE html>
<html lang="en">
<head>
    <script src= "http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src= "http://js.pusher.com/2.2/pusher.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="static/css/pushertusher.css">
    <meta charset="UTF-8">
    <title>채팅</title>

    <script type="text/javascript">
    $(document).ready(function(){
        $("#submitNickname").click(function(){
            $.ajax({
                url: "/login",
                type: "POST",
                dataType: "JSON",
                data: {
                    nickname: $("#inputNickname").val()
                },
                success: function(data){
                    if(data.success){
                        alert(data.nickname + data.message)
                        console.log("We got user's nickname successfully!")

                        $("#login").css("display", "none");
                        $("#chat_room").css("display", "block");

                        var pusher = new Pusher('9f04d3ecab45dc1b9f18');
                        var miniming = pusher.subscribe('presence-miniming');

                        miniming.bind("pusher:subscription_succeeded", function(members){
                            console.log("A new comer!")
                            members.each(function(member){
                                $(".users").append("<li id='member_" + member.id + "'>" + member.info.username + "</li>");
                            })

                        })

                        miniming.bind("pusher:member_added", function(member){
                            console.log("new member!")
                            $(".messages").append(member.info.username + " 님이 입장함!");
                            $(".users").append("<li id='member_" + member.id + "'>" + member.info.username + "</li>")
                        })

                        miniming.bind("pusher:member_removed", function(member){
                            console.log("a member has gone!")
                            // $("#member.id").remove();
                            $("#member_"+member.id).remove();
                            console.log("what?")
                            $(".messages").append(member.info.username + " 님이 나가버림!");
                        })

                        miniming.bind('new_message', function(data){
                            $(".messages").append("<p>" + data.username + ":" + data.message + "&hearts;" + " 작성시간:" + data.time + "</p>")
                            $(".messages").val("")
                        });

                        $("#submitMessage").click(function(){
                            $.ajax({
                                url: "/new_message",
                                type: "POST",
                                dataType: "JSON",
                                data: {
                                    message: $("#inputMessage").val()
                                },
                                success: function(data){
                                    if(data.success){
                                        console.log("Successfully sent new message!")
                                    }
                                    else{
                                        console.log("Failed to send new message!")
                                    }
                                },
                                error: function(data){
                                    console.log("Server error! T~T")
                                }
                            });
                        });
                    }
                    else{
                        console.log("Well, there's something wrong with user's nickname.")
                    }
                },

                error: function(data){
                    console.log("Totally gone bad!")
                }
            });
});
});
</script>

</head>
<body>  
    <div class="container">

        <!-- Login form -->
        <div class="form-group" id="login">
            <label for="inputNickname" class="col-md-2 control-label">
                닉네임을 입력하세요!
            </label>

            <div class="col-md-2">
                <input type="text" class="form-control" id="inputNickname" name="nickname" maxlength="6" placeholder="6자 이내">
            </div>

            <button type="submit" id="submitNickname" class="btn btn-default">결정!</button>
        </div>
        <!-- Login form ends -->

        <div id="chat_room">
            <!-- chat logs -->
            <div class="col-sm-9 messages">
                <h1>항상 서로에게 좋은 메시지를 줍시다!</h1>
            </div>
            <!-- chat logs ends -->
            
            <!-- users -->
            <div class="col-sm-2 col-sm-offset-1 users">
                <h2>접속자</h2>
            </div>
            <!-- users end -->
            
            <!-- Chat form -->
            <div class="form-group">
                <label for="inputMessage" class="col-sm-1 control-label">
                    메시지
                </label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputMessage" name="message" maxlength="100" placeholder="100자 제한">
                </div>
                <button type="submit" id="submitMessage" class="btn btn-default">보내기!</button>
            </div>
            <!-- Chat form ends -->
            

        </div>
    </div>
</body>
</html>